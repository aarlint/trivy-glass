<script lang="ts">
	import { TableSearch, TableHead, TableBody, TableBodyRow, TableBodyCell, Badge, Breadcrumb, BreadcrumbItem, Button } from 'svelte-5-ui-lib';
	import { onMount } from 'svelte';

	export let data: {
		report: VulnerabilityReport;
		clusterName: string;
	};

	interface VulnerabilityReport {
		metadata: { uid: string; name: string; namespace: string };
		report: {
			summary: {
				CRITICALCount: number;
				HIGHCount: number;
				MEDIUMCount: number;
				lowCount: number;
				noneCount: number;
				unknownCount: number;
			};
			vulnerabilities: Vulnerability[];
		};
	}

	interface Vulnerability {
		title: string;
		vulnerabilityID: string;
		resource: string;
		installedVersion: string;
		fixedVersion?: string;
		score: number;
		severity: string;
		publishedDate: string;
		primaryLink: string;
	}

	let searchTerm = '';
	let { report } = data;
	let filteredVulnerabilities = [];

	const severityOrder = {
		'CRITICAL': 1,
		'HIGH': 2,
		'MEDIUM': 3,
		'LOW': 4,
		'UNKNOWN': 5,
		'NONE': 6
	};

	$: filteredVulnerabilities = report.report.vulnerabilities
		.filter((vuln) =>
			vuln.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
			vuln.vulnerabilityID.toLowerCase().includes(searchTerm.toLowerCase())
		)
		.sort((a, b) => severityOrder[a.severity] - severityOrder[b.severity]);
</script>

<style>
	.table-full-width {
		width: 100%; /* Forces the table to use the full width of its container */
	}
	.word-wrap {
		word-wrap: break-word; /* Ensures text does not overflow its container */
	}
	.overflow-auto {
		overflow-x: auto; /* Adds horizontal scrolling if the table exceeds the page width */
	}
</style>

<div class="p-2 sm:p-6">
	<Breadcrumb>
		<BreadcrumbItem href="/" home>Home</BreadcrumbItem>
		<BreadcrumbItem href="/vulnerabilityreports">Vulnerability Reports</BreadcrumbItem>
		<BreadcrumbItem>{report.metadata.name}</BreadcrumbItem>
	</Breadcrumb>

	<div class="overflow-auto"> <!-- Container to allow horizontal scrolling -->
		<TableSearch class="table-full-width" placeholder="Search vulnerabilities by title or ID" hoverable={true} bind:inputValue={searchTerm}>
			<TableHead items={['Title', 'ID', 'Package', 'Installed', 'Fixed', 'Score', 'Severity', 'Published', 'Action']} />
			<TableBody>
				<TableBodyRow>
					<TableBodyCell><strong>Title</strong></TableBodyCell>
					<TableBodyCell><strong>ID</strong></TableBodyCell>
					<TableBodyCell><strong>Package</strong></TableBodyCell>
					<TableBodyCell><strong>Installed</strong></TableBodyCell>
					<TableBodyCell><strong>Fixed</strong></TableBodyCell>
					<TableBodyCell><strong>Score</strong></TableBodyCell>
					<TableBodyCell><strong>Severity</strong></TableBodyCell>
					<TableBodyCell><strong>Published</strong></TableBodyCell>
					<TableBodyCell><strong>Action</strong></TableBodyCell>
				</TableBodyRow>
				{#each filteredVulnerabilities as vuln}
					<TableBodyRow>
						<TableBodyCell>{vuln.title.length > 50 ? vuln.title.slice(0, 50) + '...' : vuln.title}</TableBodyCell>
						<TableBodyCell>{vuln.vulnerabilityID}</TableBodyCell>
						<TableBodyCell>{vuln.resource}</TableBodyCell>
						<TableBodyCell>{vuln.installedVersion}</TableBodyCell>
						<TableBodyCell>{vuln.fixedVersion || 'N/A'}</TableBodyCell>
						<TableBodyCell>{vuln.score}</TableBodyCell>
						<TableBodyCell>
							<Badge color={vuln.severity === 'CRITICAL' ? 'red' :
								vuln.severity === 'HIGH' ? 'orange' :
								vuln.severity === 'MEDIUM' ? 'yellow' :
								vuln.severity === 'LOW' ? 'green' : 'gray'}>{vuln.severity}</Badge>
						</TableBodyCell>
						<TableBodyCell>{vuln.publishedDate}</TableBodyCell>
						<TableBodyCell>
							<Button size="sm" onclick={() => window.open(vuln.primaryLink, '_blank')}>Details</Button>
						</TableBodyCell>
					</TableBodyRow>
				{/each}
			</TableBody>
		</TableSearch>
	</div>
</div>
