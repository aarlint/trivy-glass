<script lang="ts">
  import { Table, TableHead, TableBody, TableBodyRow, TableBodyCell, TableHeadCell } from 'svelte-5-ui-lib';
  import { Badge, Button } from 'svelte-5-ui-lib';
  import { P } from "svelte-5-ui-lib";
  export let data: {
    reports: VulnerabilityReport[];
    clusterName: string; // Add clusterName property
  };

  interface VulnerabilityReport {
    metadata: {
      uid: string;
      name: string;
      namespace: string;
    };
    report: {
      summary: {
        criticalCount: number;
        highCount: number;
        mediumCount: number;
        lowCount: number;
        noneCount: number;
        unknownCount: number;
      };
    };
  }

  const { reports, clusterName } = data; // Destructure clusterName from data

  // Calculate overall summary counts
  let summaryCounts = {
    criticalCount: 0,
    highCount: 0,
    mediumCount: 0,
    lowCount: 0,
    noneCount: 0,
    unknownCount: 0
  };

  for (const report of reports) {
    summaryCounts.criticalCount += report.report.summary.criticalCount;
    summaryCounts.highCount += report.report.summary.highCount;
    summaryCounts.mediumCount += report.report.summary.mediumCount;
    summaryCounts.lowCount += report.report.summary.lowCount;
    summaryCounts.noneCount += report.report.summary.noneCount;
    summaryCounts.unknownCount += report.report.summary.unknownCount;
  }
</script>

<div class="">
  <header class="mb-8">
    <P
   size="xl"
   weight="bold"
   space="wide"
   height="loose"
   align="center"
>Vulnerability Reports</P>
<P
size="xl"
weight="bold"
space="wide"
height="loose"
align="center"
>Cluster: {clusterName}</P> <!-- Display clusterName -->
    <div class="text-center mt-4">
      <p class="text-red-600">Critical: {summaryCounts.criticalCount}</p>
      <p class="text-orange-600">High: {summaryCounts.highCount}</p>
      <p class="text-yellow-600">Medium: {summaryCounts.mediumCount}</p>
      <p class="text-green-600">Low: {summaryCounts.lowCount}</p>
      <p class="text-gray-600">None: {summaryCounts.noneCount}</p>
      <p class="text-blue-600">Unknown: {summaryCounts.unknownCount}</p>
    </div>
  </header>

  <main>
    {#if reports.length === 0}
      <P class="text-center">No vulnerability reports found.</P>
    {:else}
      <Table>
        <TableHead>
          <TableHeadCell>Namespace</TableHeadCell>
          <TableHeadCell>Name</TableHeadCell>
          <TableHeadCell>Summary</TableHeadCell>
          <TableHeadCell>Actions</TableHeadCell>
        </TableHead>
        <TableBody>
          {#each reports as report (report.metadata.uid)}
            <TableBodyRow>
              <TableBodyCell>{report.metadata.namespace}</TableBodyCell>
              <TableBodyCell>{report.metadata.name}</TableBodyCell>
              <TableBodyCell>
                {#each Object.entries(report.report.summary) as [key, value]}
                  <Badge color={
                    key === 'criticalCount' ? 'red' :
                    key === 'highCount' ? 'orange' :
                    key === 'mediumCount' ? 'yellow' :
                    key === 'lowCount' ? 'green' :
                    key === 'noneCount' ? 'gray' :
                    'blue'
                  }>
                    {`${key}: ${value}`}
                  </Badge>
                {/each}
              </TableBodyCell>
              <TableBodyCell>
                <Button href={`/vulnerabilityreports/${report.metadata.namespace}/${report.metadata.name}`} color="blue" size="sm">
                  View Details
                </Button>
              </TableBodyCell>
            </TableBodyRow>
          {/each}
        </TableBody>
      </Table>
    {/if}
  </main>


</div>
<style>
  
</style>