---
include:
  - project: 'cnap/gitlab-ci-templates'
    ref: main
    file: 'gitlab-ci/security.gitlab-ci.yml'

default:
  image:
    name: $IMAGE_CI_NODEJS20_DEBIAN
    entrypoint:
      - '/usr/bin/env'
      - 'PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'
  tags:
    - CnapGroupProduction

stages:
  - test
  - publish

build-push-image:
  stage: publish
  image:
    name: registry1.dso.mil/cnap/tool/kaniko:33cf33c-3852872
    entrypoint: ['']
  variables:
    REGISTRY: registry1.dso.mil/cnap/dashboard-ui
  before_script:
    - mkdir -p /kaniko/.docker
    - echo "$DOCKER_AUTH_CONFIG_CNAP_WRITE" > /kaniko/.docker/config.json
  script:
    - |
      /kaniko/executor \
      --context . \
      --dockerfile Dockerfile \
      --destination $REGISTRY:$CI_COMMIT_TAG
  rules:
    - if: '$CI_COMMIT_TAG != null'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: always
    - when: never

# Prevent scanning pushes to Main as code has already been scanned on Merge Request
svelte-lint:
  stage: test
  script:
    - npm ci
    - npm run lint
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: never
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
      when: never
    - when: always
  cache:
    key: $CI_COMMIT_REF_SLUG
    paths:
      - .npm/
      - node_modules/

clamav_scan:
  stage: test
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: never
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
      when: never
    - when: always

kics-iac-sast:
  stage: test
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: never
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
      when: never
    - when: always

secret_detection:
  stage: test
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: never
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
      when: never
    - when: always

semgrep-sast:
  stage: test
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: never
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
      when: never
    - when: always
